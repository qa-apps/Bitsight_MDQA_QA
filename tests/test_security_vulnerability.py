import pytest
from playwright.sync_api import Page, expect
from pages.home_page import HomePage
from pages.base_page import BasePage
import re
import time

@pytest.mark.security
class TestSecurityVulnerability:
    """
    Security and vulnerability testing for BitSight website
    """
    
    def test_ssl_certificate_valid(self, page: Page):
        """
        Test that SSL certificate is valid and HTTPS is enforced
        """
        homepage = HomePage(page)
        homepage.navigate_to()
        
        # Check if URL uses HTTPS
        assert page.url.startswith('https://'), "Site not using HTTPS"
        
        # Check for mixed content warnings
        console_messages = []
        page.on('console', lambda msg: console_messages.append(msg))
        page.reload()
        
        mixed_content = [msg for msg in console_messages if 'mixed content' in str(msg).lower()]
        assert len(mixed_content) == 0, "Mixed content detected (HTTP resources on HTTPS page)"
        
    def test_xss_prevention_in_forms(self, page: Page):
        """
        Test XSS prevention in form inputs
        """
        homepage = HomePage(page)
        homepage.navigate_to()
        
        # Navigate to a page with forms
        homepage.click_request_demo()
        page.wait_for_load_state('networkidle')
        
        # Find form inputs
        inputs = page.locator('input[type="text"], input[type="email"], textarea').all()
        
        if len(inputs) > 0:
            # Try XSS payload in first available input
            xss_payload = '<script>alert("XSS")</script>'
            test_input = inputs[0]
            
            if test_input.is_visible():
                test_input.fill(xss_payload)
                
                # Check if script tags are escaped in the DOM
                page.wait_for_timeout(1000)
                page_content = page.content()
                
                # Script should be escaped, not executable
                assert '<script>alert("XSS")</script>' not in page_content or '&lt;script&gt;' in page_content, "XSS payload not properly escaped"
                
    def test_sql_injection_prevention(self, page: Page):
        """
        Test SQL injection prevention in search and forms
        """
        homepage = HomePage(page)
        homepage.navigate_to()
        
        # Look for search functionality
        search_trigger = page.locator('[aria-label*="search" i], button:has-text("Search")').first
        
        if search_trigger.is_visible():
            search_trigger.click()
            search_input = page.locator('input[type="search"], input[placeholder*="search" i]').first
            
            if search_input.is_visible():
                # Try SQL injection payload
                sql_payload = "' OR '1'='1"
                search_input.fill(sql_payload)
                search_input.press("Enter")
                
                page.wait_for_load_state('networkidle')
                
                # Check for database errors
                error_indicators = ['mysql', 'sql error', 'database error', 'syntax error']
                page_text = page.content().lower()
                
                for indicator in error_indicators:
                    assert indicator not in page_text, f"Potential SQL injection vulnerability: {indicator} found"
                    
    def test_clickjacking_protection(self, page: Page):
        """
        Test for clickjacking protection headers
        """
        homepage = HomePage(page)
        
        # Make a request and check headers
        response = page.goto(homepage.base_url)
        
        if response:
            headers = response.headers
            
            # Check for X-Frame-Options
            x_frame_options = headers.get('x-frame-options', '').lower()
            csp = headers.get('content-security-policy', '').lower()
            
            # Site should have clickjacking protection
            has_protection = x_frame_options in ['deny', 'sameorigin'] or 'frame-ancestors' in csp
            assert has_protection, "No clickjacking protection headers found"
            
    def test_sensitive_data_exposure(self, page: Page):
        """
        Test for exposed sensitive data in page source
        """
        homepage = HomePage(page)
        homepage.navigate_to()
        
        page_content = page.content()
        
        # Check for exposed sensitive patterns
        sensitive_patterns = [
            r'api[_-]?key\s*[:=]\s*["\'][^"\']+["\']',
            r'password\s*[:=]\s*["\'][^"\']+["\']',
            r'token\s*[:=]\s*["\'][^"\']+["\']',
            r'secret\s*[:=]\s*["\'][^"\']+["\']',
            r'private[_-]?key\s*[:=]\s*["\'][^"\']+["\']'
        ]
        
        for pattern in sensitive_patterns:
            matches = re.findall(pattern, page_content, re.IGNORECASE)
            assert len(matches) == 0, f"Potential sensitive data exposed: {pattern}"
            
    def test_content_security_policy(self, page: Page):
